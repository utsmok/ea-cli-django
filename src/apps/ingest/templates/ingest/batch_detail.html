{% extends "ingest/base.html" %}

{% block page_title %}Batch #{{ batch.id }} - Copyright Ingestion{% endblock %}

{% block main_content %}
<div class="mb-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold uppercase tracking-wide">Batch #{{ batch.id }}</h1>
    <a href="{% url 'ingest:batch_list' %}" class="btn btn-ut btn-outline btn-sm">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to List
    </a>
  </div>
</div>

{% include "ingest/partials/batch_status.html" %}

{% if qlik_entries %}
<div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
  <div class="card-body p-6">
    <h2 class="card-title text-xl mb-4">Qlik Entries</h2>
    <p class="text-sm text-base-content/60 mb-4">Showing first 20 entries</p>
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Material ID</th>
            <th>Title</th>
            <th>Filename</th>
            <th>Faculty</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in qlik_entries %}
          <tr>
            <td class="font-mono">{{ entry.material_id }}</td>
            <td class="max-w-xs truncate">{{ entry.title|default:"—" }}</td>
            <td class="max-w-xs truncate">{{ entry.filename|default:"—" }}</td>
            <td>{{ entry.faculty|default:"—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if faculty_entries %}
<div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
  <div class="card-body p-6">
    <h2 class="card-title text-xl mb-4">Faculty Entries</h2>
    <p class="text-sm text-base-content/60 mb-4">Showing first 20 entries</p>
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Material ID</th>
            <th>Workflow Status</th>
            <th>Classification</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in faculty_entries %}
          <tr>
            <td class="font-mono">{{ entry.material_id }}</td>
            <td>{{ entry.workflow_status|default:"—" }}</td>
            <td>{{ entry.v2_manual_classification|default:"—" }}</td>
            <td class="max-w-xs truncate">{{ entry.remarks|default:"—" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% if processing_failures %}
<div class="card bg-base-100 shadow-sm border border-base-300 border-l-4 border-l-error mb-6">
  <div class="card-body p-6">
    <h2 class="card-title text-xl text-error flex items-center gap-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Processing Failures ({{ processing_failures|length }})
    </h2>
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>Row</th>
            <th>Material ID</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          {% for failure in processing_failures %}
          <tr>
            <td class="font-mono">{{ failure.row_number }}</td>
            <td class="font-mono">{{ failure.material_id|default:"—" }}</td>
            <td class="text-error text-sm">{{ failure.error_message|truncatewords:20 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if batch.status == 'STAGING' or batch.status == 'PROCESSING' %}
<script>
  // Auto-refresh every 3 seconds if batch is processing
  setTimeout(() => {
    location.reload();
  }, 3000);
</script>
{% endif %}
{% endblock %}
