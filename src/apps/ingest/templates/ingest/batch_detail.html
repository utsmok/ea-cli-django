{% extends "ingest/base.html" %}

{% block title %}Batch #{{ batch.id }} - Copyright Ingestion{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Batch #{{ batch.id }}</h1>
    <a href="{% url 'ingest:batch_list' %}" class="btn btn-secondary">← Back to List</a>
</div>

{% include "ingest/partials/batch_status.html" %}

{% if qlik_entries %}
<div class="card">
    <h2>Qlik Entries (showing first 20)</h2>
    <table>
        <thead>
            <tr>
                <th>Material ID</th>
                <th>Title</th>
                <th>Filename</th>
                <th>Faculty</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in qlik_entries %}
            <tr>
                <td>{{ entry.material_id }}</td>
                <td>{{ entry.title|default:"—"|truncatewords:10 }}</td>
                <td>{{ entry.filename|default:"—"|truncatewords:5 }}</td>
                <td>{{ entry.faculty|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if faculty_entries %}
<div class="card">
    <h2>Faculty Entries (showing first 20)</h2>
    <table>
        <thead>
            <tr>
                <th>Material ID</th>
                <th>Workflow Status</th>
                <th>Classification</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in faculty_entries %}
            <tr>
                <td>{{ entry.material_id }}</td>
                <td>{{ entry.workflow_status|default:"—" }}</td>
                <td>{{ entry.v2_manual_classification|default:"—" }}</td>
                <td>{{ entry.remarks|default:"—"|truncatewords:10 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if processing_failures %}
<div class="card" style="border-left: 4px solid #e74c3c;">
    <h2>Processing Failures ({{ processing_failures|length }})</h2>
    <table>
        <thead>
            <tr>
                <th>Row</th>
                <th>Material ID</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for failure in processing_failures %}
            <tr>
                <td>{{ failure.row_number }}</td>
                <td>{{ failure.material_id|default:"—" }}</td>
                <td><small>{{ failure.error_message|truncatewords:20 }}</small></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if batch.status == 'STAGING' or batch.status == 'PROCESSING' %}
<script>
    // Auto-refresh every 3 seconds if batch is processing
    setTimeout(() => {
        location.reload();
    }, 3000);
</script>
{% endif %}
{% endblock %}
