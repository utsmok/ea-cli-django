{% extends "ingest/base.html" %}

{% block title %}Batch #{{ batch.id }} - Copyright Ingestion{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Batch #{{ batch.id }}</h1>
    <a href="{% url 'ingest:batch_list' %}" class="btn btn-secondary">← Back to List</a>
</div>

<div class="card">
    <h2>Batch Information</h2>
    <table>
        <tr>
            <th style="width: 200px;">Status</th>
            <td>
                <span class="badge badge-{{ batch.status|lower }}">
                    {{ batch.get_status_display }}
                </span>
            </td>
        </tr>
        <tr>
            <th>Source Type</th>
            <td>{{ batch.get_source_type_display }}</td>
        </tr>
        <tr>
            <th>Faculty Code</th>
            <td>{{ batch.faculty_code|default:"N/A" }}</td>
        </tr>
        <tr>
            <th>File</th>
            <td>{{ batch.source_file.name }}</td>
        </tr>
        <tr>
            <th>Uploaded By</th>
            <td>{{ batch.uploaded_by.username }}</td>
        </tr>
        <tr>
            <th>Uploaded At</th>
            <td>{{ batch.uploaded_at }}</td>
        </tr>
        {% if batch.started_at %}
        <tr>
            <th>Started At</th>
            <td>{{ batch.started_at }}</td>
        </tr>
        {% endif %}
        {% if batch.completed_at %}
        <tr>
            <th>Completed At</th>
            <td>{{ batch.completed_at }}</td>
        </tr>
        {% endif %}
    </table>
</div>

<div class="card">
    <h2>Processing Statistics</h2>
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value">{{ batch.total_rows }}</div>
            <div class="stat-label">Total Rows</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ batch.rows_staged }}</div>
            <div class="stat-label">Rows Staged</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ batch.items_created }}</div>
            <div class="stat-label">Items Created</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ batch.items_updated }}</div>
            <div class="stat-label">Items Updated</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ batch.items_skipped }}</div>
            <div class="stat-label">Items Skipped</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ batch.items_failed }}</div>
            <div class="stat-label">Items Failed</div>
        </div>
    </div>
</div>

{% if batch.error_message %}
<div class="card" style="border-left: 4px solid #e74c3c;">
    <h2>Error Message</h2>
    <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ batch.error_message }}</pre>
</div>
{% endif %}

{% if batch.status == 'PENDING' or batch.status == 'STAGED' %}
<div class="card">
    <h2>Actions</h2>
    <form method="post" action="{% url 'ingest:batch_process' batch.id %}" onsubmit="return confirm('Process this batch now?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">▶️ Process Batch</button>
    </form>
</div>
{% endif %}

{% if qlik_entries %}
<div class="card">
    <h2>Qlik Entries (showing first 20)</h2>
    <table>
        <thead>
            <tr>
                <th>Material ID</th>
                <th>Title</th>
                <th>Filename</th>
                <th>Faculty</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in qlik_entries %}
            <tr>
                <td>{{ entry.material_id }}</td>
                <td>{{ entry.title|default:"—"|truncatewords:10 }}</td>
                <td>{{ entry.filename|default:"—"|truncatewords:5 }}</td>
                <td>{{ entry.faculty|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if faculty_entries %}
<div class="card">
    <h2>Faculty Entries (showing first 20)</h2>
    <table>
        <thead>
            <tr>
                <th>Material ID</th>
                <th>Workflow Status</th>
                <th>Classification</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in faculty_entries %}
            <tr>
                <td>{{ entry.material_id }}</td>
                <td>{{ entry.workflow_status|default:"—" }}</td>
                <td>{{ entry.v2_manual_classification|default:"—" }}</td>
                <td>{{ entry.remarks|default:"—"|truncatewords:10 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if processing_failures %}
<div class="card" style="border-left: 4px solid #e74c3c;">
    <h2>Processing Failures ({{ processing_failures|length }})</h2>
    <table>
        <thead>
            <tr>
                <th>Row</th>
                <th>Material ID</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for failure in processing_failures %}
            <tr>
                <td>{{ failure.row_number }}</td>
                <td>{{ failure.material_id|default:"—" }}</td>
                <td><small>{{ failure.error_message|truncatewords:20 }}</small></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if batch.status == 'STAGING' or batch.status == 'PROCESSING' %}
<script>
// Auto-refresh every 3 seconds if batch is processing
setTimeout(() => {
    location.reload();
}, 3000);
</script>
{% endif %}
{% endblock %}
