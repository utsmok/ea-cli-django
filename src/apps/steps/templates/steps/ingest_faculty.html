{% extends "steps/base_step.html" %}

{% block input_selection %}
<form id="faculty-upload-form" method="post" action="{% url 'ingest:upload' %}" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="source_type" value="FACULTY">
  
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text font-semibold">Faculty Code *</span>
    </label>
    <select name="faculty_code" class="select select-bordered select-primary" required>
      <option value="">-- Select Faculty --</option>
      <option value="EEMCS">EEMCS - Electrical Engineering, Mathematics & Computer Science</option>
      <option value="BMS">BMS - Behavioural, Management & Social Sciences</option>
      <option value="ET">ET - Engineering Technology</option>
      <option value="TNW">TNW - Science & Technology</option>
      <option value="ITC">ITC - Geo-Information Science & Earth Observation</option>
      <option value="MB">MB - Management & Governance</option>
    </select>
    <label class="label">
      <span class="label-text-alt text-base-content/60">
        Select the faculty for this update sheet
      </span>
    </label>
  </div>

  <div class="form-control">
    <label class="label">
      <span class="label-text font-semibold">Upload Faculty Sheet</span>
    </label>
    <div class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center hover:border-secondary transition-colors cursor-pointer" id="dropzone">
      <svg class="w-16 h-16 mx-auto mb-4 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      <p class="text-lg font-semibold mb-2">Drop faculty sheet here</p>
      <p class="text-sm text-base-content/60 mb-4">or click to browse</p>
      <input type="file" 
             name="file" 
             id="file-input" 
             accept=".xlsx,.xls" 
             required 
             class="hidden">
      <button type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('file-input').click()">
        Choose File
      </button>
    </div>
    <div id="file-name" class="text-sm text-success font-semibold mt-2 hidden"></div>
  </div>

  <div class="form-control mt-6">
    <label class="label cursor-pointer">
      <span class="label-text font-semibold">Auto-process after upload</span>
      <input type="checkbox" name="auto_process" class="toggle toggle-secondary" checked>
    </label>
    <label class="label">
      <span class="label-text-alt text-base-content/60">
        When enabled, the updates will be automatically applied to the database.
      </span>
    </label>
  </div>
</form>
{% endblock %}

{% block settings %}
<div class="space-y-4">
  <div class="alert alert-warning">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    <div>
      <h3 class="font-bold">About Faculty Sheet Ingestion</h3>
      <p class="text-sm mt-1">
        Faculty sheets should be exported from the system first, edited by faculty staff, 
        then re-uploaded. This process only updates classification and workflow fields.
      </p>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox"> 
    <div class="collapse-title font-medium">
      Editable Fields
    </div>
    <div class="collapse-content"> 
      <ul class="list-disc list-inside space-y-1 text-sm">
        <li>Workflow Status (ToDo, InProgress, Done)</li>
        <li>Classification (old system)</li>
        <li>Manual Classification</li>
        <li>V2 Manual Classification (new system)</li>
        <li>V2 Overname Status</li>
        <li>V2 Lengte (length classification)</li>
        <li>Remarks (faculty notes)</li>
        <li>Scope</li>
        <li>Manual Identifier</li>
      </ul>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox"> 
    <div class="collapse-title font-medium">
      Field Protection Rules
    </div>
    <div class="collapse-content"> 
      <p class="text-sm text-base-content/70">
        Faculty sheets can ONLY update human-annotated fields on existing items.
        System fields (title, author, course codes, etc.) are protected and will not be modified.
        New items cannot be created from faculty sheets.
      </p>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox"> 
    <div class="collapse-title font-medium">
      Expected Sheet Structure
    </div>
    <div class="collapse-content"> 
      <p class="text-sm text-base-content/70 mb-2">
        The Excel file must contain a "Data entry" sheet with:
      </p>
      <ul class="list-disc list-inside space-y-1 text-sm">
        <li>Material ID column (to match existing items)</li>
        <li>Classification fields</li>
        <li>Workflow status column</li>
        <li>Remarks column</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block action_button %}
<button type="submit" 
        form="faculty-upload-form"
        class="btn btn-secondary btn-lg w-full"
        id="upload-btn">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
  </svg>
  Upload & Process Faculty Sheet
</button>
{% endblock %}

{% block quick_stats %}
<div class="stats stats-vertical shadow">
  <div class="stat">
    <div class="stat-title">Total Batches</div>
    <div class="stat-value text-2xl">{{ total_batches }}</div>
    <div class="stat-desc">All time</div>
  </div>
  
  <div class="stat">
    <div class="stat-title">Recent Faculty Updates</div>
    <div class="stat-value text-2xl text-secondary">{{ faculty_batches }}</div>
    <div class="stat-desc">Last 30 days</div>
  </div>
  
  <div class="stat">
    <div class="stat-title">Items Updated</div>
    <div class="stat-value text-2xl text-success">{{ total_updated }}</div>
    <div class="stat-desc">From faculty sheets</div>
  </div>
</div>
{% endblock %}

{% block results %}
{% if recent_batches %}
<div class="overflow-x-auto">
  <table class="table table-zebra">
    <thead>
      <tr>
        <th>Batch ID</th>
        <th>Faculty</th>
        <th>Uploaded</th>
        <th>Status</th>
        <th>Items Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for batch in recent_batches %}
      <tr>
        <td class="font-mono">#{{ batch.id }}</td>
        <td><span class="badge badge-outline">{{ batch.faculty_code }}</span></td>
        <td>{{ batch.uploaded_at|date:"Y-m-d H:i" }}</td>
        <td>
          <span class="badge badge-{{ batch.status|lower }}">
            {{ batch.get_status_display }}
          </span>
        </td>
        <td class="text-info font-semibold">{{ batch.items_updated }}</td>
        <td>
          <a href="{% url 'ingest:batch_detail' batch.id %}" class="btn btn-sm btn-ghost">
            View Details
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="text-center text-base-content/60 py-8">
  <p>No recent faculty updates. Upload your first faculty sheet above.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// File upload handling
const fileInput = document.getElementById('file-input');
const dropzone = document.getElementById('dropzone');
const fileName = document.getElementById('file-name');

// Click to upload
dropzone.addEventListener('click', function(e) {
  if (e.target.id !== 'file-input') {
    fileInput.click();
  }
});

// Drag and drop
dropzone.addEventListener('dragover', function(e) {
  e.preventDefault();
  dropzone.classList.add('border-secondary', 'bg-secondary/5');
});

dropzone.addEventListener('dragleave', function(e) {
  e.preventDefault();
  dropzone.classList.remove('border-secondary', 'bg-secondary/5');
});

dropzone.addEventListener('drop', function(e) {
  e.preventDefault();
  dropzone.classList.remove('border-secondary', 'bg-secondary/5');
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    fileInput.files = files;
    showFileName(files[0].name);
  }
});

// Show selected file name
fileInput.addEventListener('change', function() {
  if (fileInput.files.length > 0) {
    showFileName(fileInput.files[0].name);
  }
});

function showFileName(name) {
  fileName.textContent = 'âœ“ Selected: ' + name;
  fileName.classList.remove('hidden');
}
</script>
{% endblock %}
