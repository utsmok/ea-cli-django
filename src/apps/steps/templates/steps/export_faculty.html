{% extends "steps/base_step.html" %}
{% load steps_filters %}

{% block input_selection %}
<form id="export-form" method="post" action="{% url 'steps:run_export_faculty' %}">
  {% csrf_token %}
  <div class="form-control mb-6">
    <label class="label">
      <span class="label-text font-semibold">Export Scope</span>
    </label>
    <label class="label cursor-pointer">
      <input type="checkbox" name="export_all" value="true" class="checkbox checkbox-info" id="export-all" checked>
      <span class="label-text">Export all faculties</span>
    </label>
  </div>

  <div id="faculty-selection" class="hidden ml-6 mb-4">
    <label class="label">
      <span class="label-text font-semibold">Select Faculties</span>
    </label>
    <div class="form-control">
      {% for faculty in faculties %}
      <label class="label cursor-pointer justify-start gap-2">
        <input type="checkbox" name="faculty_codes" value="{{ faculty.abbreviation }}" class="checkbox checkbox-info">
        <span class="label-text">{{ faculty.abbreviation }} - {{ faculty.name }}</span>
      </label>
      {% endfor %}
    </div>
  </div>
</form>
{% endblock %}

{% block settings %}
<div class="space-y-4">
  <div class="alert alert-info">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <div>
      <h3 class="font-bold">About Faculty Sheet Export</h3>
      <p class="text-sm mt-1">
        Exports create Excel workbooks organized by workflow status (inbox, in_progress, done, overview).
        Each workbook has two sheets: "Complete data" (read-only) and "Data entry" (editable).
      </p>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox">
    <div class="collapse-title font-medium">
      Export Structure
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70 mb-2">Each faculty export includes:</p>
      <ul class="list-disc list-inside space-y-1 text-sm">
        <li><strong>inbox.xlsx</strong> - Items with workflow status "ToDo"</li>
        <li><strong>in_progress.xlsx</strong> - Items with workflow status "InProgress"</li>
        <li><strong>done.xlsx</strong> - Items with workflow status "Done"</li>
        <li><strong>overview.xlsx</strong> - All items for the faculty</li>
      </ul>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox">
    <div class="collapse-title font-medium">
      Sheet Protection
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70">
        The "Data entry" sheet has protected columns for system fields.
        Only classification and workflow fields are editable by faculty staff.
        This prevents accidental modification of critical data.
      </p>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox">
    <div class="collapse-title font-medium">
      Conditional Formatting
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70 mb-2">
        Applied automatically to highlight important information:
      </p>
      <ul class="list-disc list-inside space-y-1 text-sm">
        <li>File existence status (green/red)</li>
        <li>Workflow status (color-coded)</li>
        <li>Length classifications</li>
      </ul>
    </div>
  </div>

  <div class="collapse collapse-arrow bg-base-200">
    <input type="checkbox">
    <div class="collapse-title font-medium">
      Backup & Versioning
    </div>
    <div class="collapse-content">
      <p class="text-sm text-base-content/70">
        Previous exports are automatically backed up with timestamps.
        Change tracking files (update_info.txt, update_overview.csv) are generated
        to show what changed since the last export.
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block action_button %}
<button type="submit"
        form="export-form"
        class="btn btn-info btn-lg w-full"
        hx-post="{% url 'steps:run_export_faculty' %}"
        hx-target="#progress-container"
        hx-swap="innerHTML">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
  </svg>
  Generate Faculty Sheets
</button>
{% endblock %}

{% block quick_stats %}
<div class="stats stats-vertical shadow">
  <div class="stat">
    <div class="stat-title">Total Items</div>
    <div class="stat-value text-2xl">{{ total_items }}</div>
  </div>

  <div class="stat">
    <div class="stat-title">By Workflow Status</div>
    <div class="stat-value text-xl">
      <div class="flex flex-col gap-1 text-sm">
        <span class="badge badge-warning">ToDo: {{ todo_count }}</span>
        <span class="badge badge-info">InProgress: {{ in_progress_count }}</span>
        <span class="badge badge-success">Done: {{ done_count }}</span>
      </div>
    </div>
  </div>

  <div class="stat">
    <div class="stat-title">Faculties</div>
    <div class="stat-value text-2xl">{{ faculty_count }}</div>
    <div class="stat-desc">Active faculties</div>
  </div>
</div>
{% endblock %}

{% block progress %}
<div id="progress-container" class="hidden">
  <div class="alert alert-success">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <div>
      <h3 class="font-bold">Export Completed!</h3>
      <p class="text-sm">Your faculty sheets have been generated successfully.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block results %}
<div class="alert alert-info">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <div>
    <p class="text-sm">
      Export files will be saved to: <code class="bg-base-200 px-2 py-1 rounded">{{ export_path }}</code>
    </p>
  </div>
</div>

{% if recent_exports %}
<div class="mt-6">
  <h3 class="text-lg font-semibold mb-4">Recent Exports</h3>
  <div class="overflow-x-auto">
    <table class="table table-zebra table-sm">
      <thead>
        <tr>
          <th>Faculties</th>
          <th>Exported</th>
          <th>Items</th>
          <th>Files</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for export in recent_exports %}
        <tr>
          <td>
            {% for faculty in export.faculties %}
            <span class="badge badge-outline">{{ faculty }}</span>
            {% empty %}
            <span class="badge badge-info">All</span>
            {% endfor %}
          </td>
          <td>{{ export.created_at|date:"Y-m-d H:i" }}</td>
          <td>{{ export.total_items }}</td>
          <td>{{ export.total_files }}</td>
          <td>
            {% if export.status == "COMPLETED" %}
            <span class="badge badge-success">Complete</span>
            {% elif export.status == "RUNNING" %}
            <span class="badge badge-warning">Running</span>
            {% else %}
            <span class="badge badge-error">Failed</span>
            {% endif %}
          </td>
          <td>
            {% if export.status == "COMPLETED" and export.files_created %}
            <div class="dropdown">
              <label tabindex="0" class="btn btn-sm btn-primary">Download</label>
              <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                {% for file_path in export.files_created %}
                <li>
                  <a href="{% url 'steps:download_export_file' export.id forloop.counter0 %}"
                     class="link link-primary"
                     download="{{ file_path|filename }}">
                    ðŸ“„ {{ file_path|filename }}
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% elif export.status == "FAILED" %}
            <span class="text-xs text-error" title="{{ export.error_message }}">Failed</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const exportAllCheckbox = document.getElementById('export-all');
const facultySelection = document.getElementById('faculty-selection');
const exportForm = document.getElementById('export-form');
const facultyCheckboxes = document.querySelectorAll('input[name="faculty_codes"]');

// Toggle faculty selection visibility
exportAllCheckbox.addEventListener('change', function() {
  if (this.checked) {
    facultySelection.classList.add('hidden');
    // Uncheck all faculty checkboxes
    facultyCheckboxes.forEach(cb => cb.checked = false);
  } else {
    facultySelection.classList.remove('hidden');
  }
});

// Uncheck "export all" when any faculty is selected
facultyCheckboxes.forEach(cb => {
  cb.addEventListener('change', function() {
    if (this.checked) {
      exportAllCheckbox.checked = false;
    }
  });
});

// Validate form before submission
exportForm.addEventListener('submit', function(e) {
  const anyFacultyChecked = Array.from(facultyCheckboxes).some(cb => cb.checked);

  if (!exportAllCheckbox.checked && !anyFacultyChecked) {
    e.preventDefault();
    alert('Please select at least one faculty or check "Export all faculties"');
    return false;
  }

  return true;
});
</script>
{% endblock %}
