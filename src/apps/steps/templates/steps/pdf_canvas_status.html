{% extends "steps/base_step.html" %}

{% block input_selection %}
<form id="pdf-canvas-form" method="post" action="{% url 'steps:run_pdf_canvas_status' %}">
  {% csrf_token %}
  
  <div class="form-control mb-4">
    <label class="label cursor-pointer">
      <span class="label-text font-semibold">Selection Mode</span>
      <input type="radio" name="selection_mode" value="all" class="radio radio-primary" checked id="check-all-radio">
    </label>
    <label class="label cursor-pointer">
      <span class="label-text">Check all items with Canvas URLs ({{ items_without_pdfs }} items)</span>
    </label>
  </div>

  <div class="form-control mb-4">
    <label class="label cursor-pointer">
      <input type="radio" name="selection_mode" value="specific" class="radio radio-primary" id="check-specific-radio">
      <span class="label-text font-semibold">Select specific items</span>
    </label>
  </div>

  <div id="item-selection" class="hidden">
    <div class="overflow-x-auto max-h-96 border rounded-lg">
      <table class="table table-sm table-zebra">
        <thead class="sticky top-0 bg-base-200">
          <tr>
            <th>
              <input type="checkbox" class="checkbox checkbox-sm" id="select-all-items">
            </th>
            <th>Material ID</th>
            <th>Title</th>
            <th>URL</th>
            <th>PDF Status</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>
              <input type="checkbox" name="item_ids" value="{{ item.material_id }}" class="checkbox checkbox-sm item-checkbox">
            </td>
            <td class="font-mono">{{ item.material_id }}</td>
            <td class="max-w-xs truncate">{{ item.title|default:"—" }}</td>
            <td class="max-w-xs truncate text-xs">{{ item.url|default:"—" }}</td>
            <td>
              {% if item.document %}
                <span class="badge badge-success badge-sm">Downloaded</span>
              {% else %}
                <span class="badge badge-warning badge-sm">Pending</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="text-sm text-base-content/60 mt-2">
      Showing up to 100 items with Canvas URLs
    </p>
  </div>
</form>
{% endblock %}

{% block settings %}
<div class="space-y-4">
  <div class="form-control">
    <label class="label">
      <span class="label-text font-semibold">Canvas API URL</span>
    </label>
    <input type="text" 
           value="https://canvas.utwente.nl/api/v1" 
           class="input input-bordered" 
           disabled>
    <label class="label">
      <span class="label-text-alt text-base-content/60">Configured in environment settings</span>
    </label>
  </div>

  <div class="form-control">
    <label class="label">
      <span class="label-text font-semibold">Canvas API Token</span>
    </label>
    <input type="password" 
           value="••••••••••••••••" 
           class="input input-bordered" 
           disabled>
    <label class="label">
      <span class="label-text-alt text-base-content/60">Stored securely in environment</span>
    </label>
  </div>

  <div class="form-control">
    <label class="cursor-pointer label">
      <span class="label-text font-semibold">Download PDFs automatically</span>
      <input type="checkbox" 
             class="checkbox checkbox-primary" 
             checked 
             disabled>
    </label>
  </div>

  <div class="alert alert-info">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span class="text-sm">Canvas API credentials must be configured in settings</span>
  </div>
</div>
{% endblock %}

{% block action_button %}
<button type="button" 
        id="run-canvas-check-btn" 
        class="btn btn-accent btn-lg w-full"
        hx-post="{% url 'steps:run_pdf_canvas_status' %}"
        hx-include="#pdf-canvas-form"
        hx-target="#progress-container"
        hx-swap="innerHTML">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
  </svg>
  Check Canvas PDF Status
</button>
{% endblock %}

{% block quick_stats %}
<div class="stats stats-vertical shadow">
  <div class="stat">
    <div class="stat-title">Total Items</div>
    <div class="stat-value text-2xl">{{ total_items }}</div>
  </div>
  
  <div class="stat">
    <div class="stat-title">With PDFs</div>
    <div class="stat-value text-2xl text-success">{{ items_with_pdfs }}</div>
  </div>
  
  <div class="stat">
    <div class="stat-title">Without PDFs</div>
    <div class="stat-value text-2xl text-warning">{{ items_without_pdfs }}</div>
  </div>
  
  <div class="stat">
    <div class="stat-title">With URLs</div>
    <div class="stat-value text-2xl text-info">{{ items_with_urls }}</div>
  </div>
</div>
{% endblock %}

{% block progress %}
<div class="text-center text-base-content/60 py-4">
  <p>Click "Check Canvas PDF Status" to start</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle between "all" and "specific" selection modes
document.getElementById('check-all-radio').addEventListener('change', function() {
  if (this.checked) {
    document.getElementById('item-selection').classList.add('hidden');
  }
});

document.getElementById('check-specific-radio').addEventListener('change', function() {
  if (this.checked) {
    document.getElementById('item-selection').classList.remove('hidden');
  }
});

// Handle "select all items" checkbox
document.getElementById('select-all-items').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.item-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
});

// Intercept form submission
document.body.addEventListener('htmx:configRequest', function(evt) {
  if (evt.detail.path === '{% url "steps:run_pdf_canvas_status" %}') {
    const checkAll = document.getElementById('check-all-radio').checked;
    evt.detail.parameters['check_all'] = checkAll ? 'true' : 'false';
  }
});

// Handle response
document.body.addEventListener('htmx:afterRequest', function(evt) {
  if (evt.detail.pathInfo.requestPath === '{% url "steps:run_pdf_canvas_status" %}') {
    if (evt.detail.successful) {
      const response = JSON.parse(evt.detail.xhr.response);
      if (response.success) {
        document.getElementById('progress-container').innerHTML = `
          <div class="alert alert-success">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>${response.message}</span>
          </div>
        `;
      }
    }
  }
});
</script>
{% endblock %}
