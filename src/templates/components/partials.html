{# ==============================================================================
   DJANGO 6.0 TEMPLATE PARTIALS - Single Source of Truth

   This file contains ALL reusable UI components for the Easy Access Platform.

   Usage:
     1. Use partials in any template: {% partial component_name param=value %}
     2. For HTMX partial updates: render(request, "template.html#partial_name", context)

   Benefits:
     - Single template load (faster than multiple includes)
     - Named, parameterized components (better DX)
     - Type-safe parameters (documented below)
     - Future-proof (Django 6.0+ native feature)
     - Better encapsulation (only passed variables available)

   DO NOT create new _*.html component files. Add new partials here.

   Partial Naming Convention:
     - snake_case matching component purpose
     - Prefix with entity if specific (e.g., workflow_tabs, editable_cell)
     - Generic components use descriptive name (e.g., button, card, toast)

   Components (10 total):
     - editable_cell: Inline edit for table cells with HTMX
     - workflow_tabs: Status filter tabs with counts
     - status_badge: Display status with conditional styling
     - filter_dropdown: Generic select dropdown for filtering
     - filter_search: Search input with delayed trigger
     - button: Generic button with variants
     - progress: Visual progress bar
     - stat_card: Display stats with colored accent
     - card: Generic card container
     - toast: Auto-dismissing notifications
   ============================================================================== #}
{% load steps_filters %}

{# ==============================================================================
   HIGH PRIORITY COMPONENTS
   ============================================================================== #}

{# Editable Cell - Generic inline-edit component for table cells with HTMX #}
{% partialdef editable_cell item_id field_name value choices=None input_type="select" badge=False %}
{% if input_type == "text" %}
  {# Text input (for remarks) #}
  <div @click.stop>
    <input
      type="text"
      name="value"
      value="{{ value|default:'' }}"
      placeholder="Add remark..."
      class="input input-ghost input-sm w-full text-left bg-transparent hover:bg-base-100 focus:bg-base-100 focus:input-bordered"
      hx-post="{% url 'dashboard:update_field' item_id %}"
      hx-vals='{"field": "{{ field_name }}"}'
      hx-trigger="change"
      hx-target="closest tr"
      hx-swap="outerHTML">
  </div>

{% else %}
  {# Select dropdown (default) #}
  <div @click.stop>
    <select
      name="value"
      class="select select-ghost select-sm w-full
        {% if badge %}inline-flex items-center gap-2 rounded-full px-3 badge{% endif %}
        {% if field_name == "v2_manual_classification" and value == "Onbekend" %}text-error font-semibold{% endif %}
        bg-transparent hover:bg-base-100 focus:bg-base-100"
      hx-post="{% url 'dashboard:update_field' item_id %}"
      hx-vals='{"field": "{{ field_name }}"}'
      hx-target="closest tr"
      hx-swap="outerHTML">
      {% for choice_value, choice_label in choices %}
        <option value="{{ choice_value }}" {% if value == choice_value %}selected{% endif %}>
          {{ choice_label }}
        </option>
      {% endfor %}
    </select>
  </div>

{% endif %}
{% endpartialdef %}

{# Workflow Tabs - Displays status filter tabs with counts #}
{% partialdef workflow_tabs workflow_choices current_status="ToDo" filter_counts=None current_filters=None total_count=0 %}
{% with current_status=current_status|default:"ToDo" %}
<div class="tabs tabs-boxed bg-base-200 p-1 rounded-lg">
  {% for value, label in workflow_choices %}
    {% with filter_counts|get:value as count %}
    <button
      class="tab tab-sm flex items-center gap-2
        {% if current_status == value %}tab-active bg-white shadow text-primary{% endif %}
        {% if current_status != value %}text-base-content/60 hover:text-base-content{% endif %}"
      hx-get="{% url 'dashboard:index' %}?status={{ value }}{% if current_filters.faculty %}&faculty={{ current_filters.faculty }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search|urlencode }}{% endif %}&per_page={{ current_filters.per_page|default:50 }}"
      hx-target="#table-container"
      hx-push-url="true">
      {{ label }}
      {% if count %}
        <span class="badge badge-sm badge-neutral">{{ count }}</span>
      {% endif %}
    </button>
    {% endwith %}
  {% endfor %}

  <button
    class="tab tab-sm flex items-center gap-2
      {% if current_status == 'All' %}tab-active bg-white shadow text-primary{% endif %}
      {% if current_status != 'All' %}text-base-content/60 hover:text-base-content{% endif %}"
    hx-get="{% url 'dashboard:index' %}?status=All{% if current_filters.faculty %}&faculty={{ current_filters.faculty }}{% endif %}{% if current_filters.search %}&search={{ current_filters.search|urlencode }}{% endif %}&per_page={{ current_filters.per_page|default:50 }}"
    hx-target="#table-container"
    hx-push-url="true">
    All
    <span class="badge badge-sm badge-neutral">{{ total_count|default:0 }}</span>
  </button>
</div>
{% endwith %}
{% endpartialdef %}

{# Status Badge - Displays status with conditional styling #}
{% partialdef status_badge status text=None %}
{% with display_text=text|default:status|title %}
<span class="ut-badge inline-flex items-center gap-2
  {% if status == "pending" %}bg-base-200 text-base-content/70
  {% elif status == "running" or status == "processing" or status == "staging" %}bg-info/10 text-info
  {% elif status == "completed" %}bg-success/10 text-success
  {% elif status == "failed" %}bg-error/10 text-error
  {% elif status == "partial" %}bg-warning/10 text-warning
  {% else %}bg-base-200 text-base-content/70{% endif %}">
  {% if status == "running" or status == "processing" or status == "staging" %}
  <span class="w-2 h-2 rounded-full bg-current animate-pulse"></span>
  {% else %}
  <span class="w-2 h-2 rounded-full bg-current"></span>
  {% endif %}
  {{ display_text }}
</span>
{% endwith %}
{% endpartialdef %}

{# Filter Dropdown Component #}
{% partialdef filter_dropdown name options selected=None label="All" include=None %}
<select name="{{ name }}"
        class="select select-bordered select-sm"
        hx-get="{% url 'dashboard:index' %}"
        hx-target="#table-container"
        {% if include %}hx-include='{{ include }}'{% endif %}>
  <option value="">{{ label|default:"All" }}</option>
  {% for opt in options %}
    {% if opt is iterable and opt.0 %}{# tuple (value, label) #}
      <option value="{{ opt.0 }}" {% if selected == opt.0 %}selected{% endif %}>
        {{ opt.1 }}
      </option>
    {% else %}{# single object with value/label attributes #}
      <option value="{{ opt.value|default:opt.abbreviation|default:opt }}" {% if selected == opt.value|default:opt.abbreviation|default:opt %}selected{% endif %}>
        {{ opt.label|default:opt.name|default:opt }}
      </option>
    {% endif %}
  {% endfor %}
</select>
{% endpartialdef %}

{# ==============================================================================
   MEDIUM PRIORITY COMPONENTS
   ============================================================================== #}

{# Filter Search Component #}
{% partialdef filter_search value="" placeholder="Search..." include=None %}
<div class="join">
  <input type="search"
         name="search"
         value="{{ value|default:'' }}"
         placeholder="{{ placeholder|default:'Search...' }}"
         class="input input-bordered input-sm join-item w-48"
         hx-get="{% url 'dashboard:index' %}"
         hx-target="#table-container"
         {% if include %}hx-include='{{ include }}'{% endif %}
         hx-trigger="keyup changed delay:300ms">
  <button class="btn btn-neutral btn-sm join-item">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
  </button>
</div>
{% endpartialdef %}

{# Button Component #}
{% partialdef button label type="button" variant="primary" size=None icon=None class="" %}
<button
  type="{{ type|default:'button' }}"
  class="btn btn-ut
    {% if variant == "primary" %}btn-primary
    {% elif variant == "success" %}btn-success
    {% elif variant == "warning" %}btn-warning
    {% elif variant == "error" %}btn-error
    {% elif variant == "ghost" %}btn-ghost
    {% elif variant == "outline" %}btn-outline
    {% else %}btn-primary{% endif %}
    {% if size %}btn-{{ size }}{% endif %}
    {{ class|default:'' }}"
>
  {% if icon %}<span class="mr-2">{{ icon|safe }}</span>{% endif %}
  {{ label }}
</button>
{% endpartialdef %}

{# Progress Bar Component #}
{% partialdef progress value=0 max=100 label=None status="primary" %}
<div class="w-full">
  {% if label %}
  <div class="flex justify-between items-center mb-1 text-sm">
    <span class="font-medium">{{ label }}</span>
    <span class="font-bold">{% if value > 0 %}{{ value|floatformat:0 }}{% else %}0{% endif %}%</span>
  </div>
  {% endif %}

  <progress
    class="progress w-full
    {% if status == "success" %}progress-success
    {% elif status == "warning" %}progress-warning
    {% elif status == "error" %}progress-error
    {% else %}progress-primary{% endif %}"
    value="{{ value|default:0 }}"
    max="{{ max|default:100 }}">
  </progress>
</div>
{% endpartialdef %}

{# Stat Card Component #}
{% partialdef stat_card value label icon=None color=None href=None %}
{% if href %}
<a href="{{ href }}" class="group block">
{% endif %}

<div class="stat bg-base-100 border border-base-300 {% if color %}border-t-4 border-t-{{ color }}{% else %}border-t-4 border-t-primary{% endif%} p-4 text-center transition-all hover:shadow-md">
  {% if icon %}
  <div class="mb-2 {% if color %}text-{{ color }}{% else %}text-primary{% endif%}">
    {{ icon|safe }}
  </div>
  {% endif %}

  <div class="stat-value text-3xl font-bold {% if color %}text-{{ color }}{% else %}text-primary{% endif%} font-condensed uppercase">
    {{ value }}
  </div>

  <div class="stat-title text-sm text-base-content/70 uppercase tracking-wider mt-1">
    {{ label }}
  </div>
</div>

{% if href %}
</a>
{% endif %}
{% endpartialdef %}

{# ==============================================================================
   LOW PRIORITY COMPONENTS
   ============================================================================== #}

{# Card Component #}
{% partialdef card title=None content=None icon=None accent=None class="" %}
<div class="card bg-base-100 shadow-sm border border-base-300 {% if accent %}border-l-4 border-l-{{ accent }}{% else %}border-l-4 border-l-primary{% endif%} {{ class|default:'' }}">
  <div class="card-body p-4">
    {% if title %}
    <h2 class="card-title text-xl flex items-center gap-2">
      {% if icon %}{{ icon|safe }}{% endif %}
      {{ title }}
    </h2>
    {% endif %}

    {% if content %}
      {{ content|safe }}
    {% else %}
      {% block body %}{% endblock %}
    {% endif %}
  </div>
</div>
{% endpartialdef %}

{# Toast Notification Component #}
{% partialdef toast message type="info" duration=3000 %}
<div x-data="{ show: true }"
     x-show="show"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 translate-y-2"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 translate-y-2"
     x-init="setTimeout(() => show = false, {{ duration|default:3000 }})"
     class="alert alert-{{ type|default:'info' }} shadow-lg rounded-lg fixed top-4 right-4 z-50 max-w-md">
  <div>
    {% if type == 'success' %}
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    {% elif type == 'error' %}
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    {% elif type == 'warning' %}
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    {% else %}
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    {% endif %}
    <span>{{ message }}</span>
  </div>
  <button @click="show = false" class="btn btn-ghost btn-sm btn-circle">âœ•</button>
</div>
{% endpartialdef %}
